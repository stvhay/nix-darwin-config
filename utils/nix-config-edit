#!/usr/bin/env bash

dir="/etc/nix-darwin"
file="$dir/flake.nix"

error()
{
  printf "Error: %s\n" "$1"
  exit 1
}

sudo_()
{
  sudo sh -c 'umask 0002 && exec "$@"' sh "$@"
}

pre-update()
(
  cd "$dir"
  if git diff --quiet
  then
    printf "\n%s\n" "Pulling updates before editing..."
    git pull || error "Cannot pull update from git repository..."
  fi
)

run-update() 
(
  cd "$dir"
  if git diff HEAD --quiet
  then
    echo "No staged or unstaged changes to $dir."
    exit 0
  fi

  printf "\n%s\n" "Updating Nix..."
  nix flake update --no-warn-dirty || error "Flake update failed after edit."
  sudo_ darwin-rebuild switch --flake . || error "Build failed after edit."
  printf "\n%s\n" "Committing to git."
  git add -A
  git commit -m "Update on $(date)."
  git push -u origin main
)

command -v git > /dev/null || error "git not installed."
[ -d "$dir/.git" ] || error "git repository not initialized in $dir"
[ -f "$file" ] || error "$file does not exist."

echo "Opening editor..."
nvim "$dir"

pre-update || exit 1
run-update

