#!/usr/bin/env bash

dir="/etc/nix-darwin"
file="$dir/flake.nix"

error()
{
  printf "Error: %s\n" "$1"
  exit 1
}

pre-update()
(
  cd "$dir"
  if git diff --quiet -- flake.nix
  then
    printf "\n%s\n" "Pulling updates before editing..."
    git pull || error "Cannot pull update from git repository..."
    sudo nix flake update --no-warn-dirty || error "Flake update failed."
    sudo darwin-rebuild switch --flake . || error "Update pulled from git failed to build."
  fi
)

run-update() 
(
  cd "$dir"
  if git diff --quiet -- flake.nix
  then
    echo "No changes to $file."
    exit 0
  fi

  printf "\n%s\n" "Updating Nix..."
  sudo nix flake update --no-warn-dirty || error "Flake update failed after edit."
  sudo darwin-rebuild switch --flake . || error "Build failed after edit."
  printf "\n%s\n" "Committing to git."
  git add flake.nix
  git commit -m "Update on $(date)."
  git push -u origin main
)

command -v git > /dev/null || error "git not installed."
[ -d "$dir/.git" ] || error "git repository not initialized in $dir"
[ -f "$file" ] || error "$file does not exist."

echo "Opening editor..."
sudo nvim "$file"

pre-update || exit 1
run-update
sudo nix-collect-garbage --delete-older-than 7d
